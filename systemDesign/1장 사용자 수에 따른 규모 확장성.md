# 1장 사용자 수에 따른 규모 확장성

### 1) 단일 서버

##### 모든 컴포넌트가 단 한대의 서버에서 실행되는 간단한 시스템

##### 웹 서버 ↔ 사용자 단말 ↔ DNS

웹 앱, 데이터베이스 , 캐시 등이 전부 서버 한 대에서 실행된다.

웹 애플리케이션 : 비즈니스 로직, 데이터 저장 등을 처리하기 위해 서버 구현용 언어(자바, 파이썬, C# 등)를 사용하고 프레젠테이션 용으로 클라이언트 구현용 언어(자바스크립트)를 사용한다.

##### 모바일 앱 : 모바일 앱과 웹 서버 간 통신을 위해서는 HTTP 프로토콜을 이용한다.



### 2) 데이터베이스

##### 서버 하나는 웹/모바일 트래픽 처리 용도, 다른 하나는 데이터베이스용으로 구성

##### 데이터베이스 ↔ 웹 서버 ↔ 사용자 단말 ↔ DNS

사용자가 늘어날 경우, 웹/모바일 트래픽 처리 서버와 데이터베이스 서버를 분리하면 각각을 독립적으로 확장할 수 있다.

데이터 베이스의 분류

- 관계형 데이터베이스(RDBMS) : 자료를 테이블과 열, 컬럼으로 표현하고 여러 테이블에 있는 데이터를 Join 할 수 있다.

  ex) MySQL, 오라클 DB, MSSQL 

- 비 관계형 데이터베이스(NoSQL) : 일반적으로 조인 연산을 지원하지 않으며, 키-값 저장소, 그래프 저장소, 컬럼 저장소, 문서 저장소로 나눌 수 있다.

  ex) CouchDB, HBase, Amazon DynamoDB



### 3) 수직적 규모 확장 vs  수평적 규모 확장

##### 수직적 규모 확장 : 스케일 업이라고도 하며, 서버에 고사양 자원(더 좋은 CPU나 RAM)을 추가하는 행위

##### 수평적 규모 확장 : 스케일 아웃이라고도 하며, 더 많은 서버를 추가하여 성능을 개선하는 행위

수직적 규모 확장에는 CPU나 RAM을 무한으로 증설할 방법은 없고, 장애에 대한 자동복구(faliover) 방안이나 다중화 방안을 제시하지 않는다.

이러한 단점 때문에 대규모 애플리케이션을 지원하는 데에는 수평적 규모 확장법이 적절하다.

##### 로드밸런서 : 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할(Layer 4, Layer 7에서 주로 사용)

##### DNS ↔ 사용자 단말 ↔ 로드 밸런서 ↔ 서버

사용자는 로드 밸런서의 공개 IP 주소로 접속하고, 웹 서버는 클라이언트의 접속을 직접 처리하지 않는다.

##### 데이터베이스 다중화 : 서버 사이에 주(master) - 부(slave) 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식

쓰기 연산은 마스터에서만 지원하고, 부 데이터베이스는 주 데이터베이스로부터 사본을 전달받아 읽기 연산만을 지원한다.

더 나은 성능, 안정성, 가용성의 이득이 있다.



### 4) 캐시

##### 자주 참조되는 데이터를 메모리 안에 두고 요청이 빨리 처리될 수 있도록 하는 저장소

##### 웹 서버 ↔ 캐시 ↔ 데이터베이스

웹 페이지를 새로고침 할 때마다 표시할 데이터를 가져오기 위해 데이터 베이스 호출이 발생하는 문제를 완화할 수 있다.

캐시는 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어난다면 고려해볼 만 하다.

만료된 데이터는 캐시에서 삭제하여야 한다.

캐시 서버는 한대만 둘 경우 단일 장애 지점이 될 가능성이 있다. 따라서 여러 지역에 캐시 서버를 분산시켜야 한다.

LRU(마지막으로 사용된 시점이 가장 오래된 데이터를 내보냄), LFU(사용된 빈도가 낮은 데이터를 내보냄), FIFO 같은 정책으로 기존 데이터를 내보내야 한다.



### 5) 콘텐츠 전송 네트워크(CDN)

##### 정적 콘텐츠를 전송하는 데 쓰이는 지리적으로 분산된 서버의 네트워크로 이미지, 비디오, CSS. JS파일 등을 캐시할 수 있다.

##### 사용자 ↔ CDN (정적 콘텐츠가 없을 때는 원본 서버에서 가져온다) ↔ 서버



### 6) 무상태(sateless) 웹 계층

##### 웹 계층을 수평적으로 확장하는 방법을 위해, 상태 정보(사용자 세션 데이터 등)를 웹 계층에서 제거하는 것.

##### 상태 정보를 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 하는 것이다. 이렇게 구성된 웹 계층을 무상태 웹 계층이라 부른다.

##### 상태 정보 의존적인 아키텍쳐

##### 상태 정보를 보관하는 서버는 클라이언트 정보, 상태를 유지하여 요청들 사이에 공유되도록 한다. 무상태 서버에는 이런 장치가 없다. 문제는 같은 클라이언트로부터의 요청은 같은 서버로 전송되어야 하기에, 로드밸런서에 부담을 준다.

##### 무상태 아키텍쳐

##### 사용자 ↔ 웹 서버 ↔ 공유 저장소

사용자로부터의 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다. 데이터 상태 정보는 웹 서버로부터 물리적으로 분리되어 있어, 단순하고 안정적이며 규모 확장이 쉽다.



### 7) 데이터 센터

사용자 위치에 따라 도메인 이름을 IP주소로 변환하여, 다양한 데이터 센터로 안내된다.

또한 장애가 발생할 경우 장애가 없는 데이터 센터로 전송된다.

![image-20220217230401099](image\1\image-20220217230401099.png)

시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴토넌트를 분리하여 독립적으로 확장되어야 하는데, 이를 위해서 메세지 큐가 필요하다.



### 8) 메세지 큐

메세지 큐는 메세지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트이다.

생산자(발행) → 메세지 큐 (소비) ↔ 소비자(구독)

메세지 큐를 이용하면 서비스 또는 서버 간 결합이 느슨해져서 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.



### 9) 로그, 매트릭, 자동화

로그 : 에러 로그를 모니터링하는 것은 중요하며, 로그를 단일 서비스로 모아주는 도구를 활용하면 더 편리하게 검색하고 조회할 수 있다.

매트릭 : 매트릭을 잘 수집하면 사업 현황 유용한 정보를 얻고, 시스템 현재 상태를 파악할 수 있다.

자동화 : 시스템이 크고 복잡해지면 자동화 도구 활용이 필요하다. 개발자가 만드는 코드의 검증 절차나 빌드, 테스트, 배포 등 절차를 자동화 할 수 있다.



### 10) 데이터베이스의 규모 확장

##### 수직적 확장 : 스케일 업이라고도 하며, 서버에 고사양 자원(더 좋은 CPU나 RAM)을 추가하는 행위

많은 양의 데이터를 보관할 수 있으나, 비용이 많이 들고 하드웨어 한계가 있어 CPU나 RAM을 무한으로 증설할 방법은 없다 

##### 수평적 확장 : 스케일 아웃이라고도 하며, 더 많은 서버를 추가하여 성능을 개선하는 행위

샤딩ㅇ이라고도 부러는데, 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.



### 11) 백만 사용자, 그 이상

웹 상태는 무상태 계층으로

모든 계층에 다중화 도입

가능한 많은 데이터를 캐시할 것

여러 데이터 센터를 지원할 것

정적 콘텐츠는 CDN을 통해 서비스 할 것

데이터 계층은 샤딩을 통해 규모를 확장할 것

각 계층은 독립적 서비스로 분할할 것

시스템을 지속적으로 모니터링하고, 자동화 도구를 활용할 것